name: Tests

on:
  push:
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env: [qa] # default QA; adjust to [dev, qa, uat] if needed
        browser: [chrome, firefox]
    env:
      TEST_ENV: ${{ matrix.env }}
      BROWSER: ${{ matrix.browser }}
      TAGS: smoke
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest -m "${{ env.TAGS }}" -n 6 --reruns 3 --reruns-delay 2 --alluredir=allure-results --junitxml=report.xml

      - name: Parse JUnit summary
        id: summary
        run: |
          python .github/scripts/parse_junit.py

      - name: Generate Allure report
        uses: simple-elf/allure-report-action@v1.8
        if: always()
        with:
          allure_results: allure-results
          gh_pages: false
          allure_report: allure-report

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-${{ matrix.browser }}-${{ matrix.env }}
          path: allure-results

      - name: Upload Allure report (static)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-report-${{ matrix.browser }}-${{ matrix.env }}
          path: allure-report

      - name: Summarize results
        if: always()
        env:
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "Environment: ${{ matrix.env }}" >> $GITHUB_STEP_SUMMARY
          echo "Browser: ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "Passed: ${{ steps.summary.outputs.passed }} / Total: ${{ steps.summary.outputs.tests }}" >> $GITHUB_STEP_SUMMARY
          echo "Failures: ${{ steps.summary.outputs.failures }}, Errors: ${{ steps.summary.outputs.errors }}, Skipped: ${{ steps.summary.outputs.skipped }}" >> $GITHUB_STEP_SUMMARY
          echo "Pass rate: ${{ steps.summary.outputs.passrate }}%" >> $GITHUB_STEP_SUMMARY
          echo "Run URL: $RUN_URL" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts: allure-results, allure-report" >> $GITHUB_STEP_SUMMARY

      - name: Send email via SMTP App Password (fallback)
        if: ${{ always() && secrets.SENDGRID_API_KEY == '' && secrets.MAIL_USERNAME != '' && secrets.MAIL_PASSWORD != '' && secrets.NOTIFY_EMAIL_TO != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "CI Test Run ${{ github.run_id }} - ${{ job.status }}"
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: CI Bot <${{ secrets.MAIL_USERNAME }}>
          secure: true
          html_body: |
            <h3>CI Test Run for ${{ github.repository }}</h3>
            <p><b>Status:</b> ${{ job.status }}</p>
            <table border="1" cellspacing="0" cellpadding="6">
              <tr><th>Environment</th><th>Browser</th><th>Total</th><th>Passed</th><th>Failures</th><th>Errors</th><th>Skipped</th><th>Pass rate</th></tr>
              <tr>
                <td>${{ matrix.env }}</td>
                <td>${{ matrix.browser }}</td>
                <td>${{ steps.summary.outputs.tests }}</td>
                <td>${{ steps.summary.outputs.passed }}</td>
                <td>${{ steps.summary.outputs.failures }}</td>
                <td>${{ steps.summary.outputs.errors }}</td>
                <td>${{ steps.summary.outputs.skipped }}</td>
                <td>${{ steps.summary.outputs.passrate }}%</td>
              </tr>
            </table>
            <p>Run URL: <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">Open in GitHub</a></p>
            <p>Artifacts: allure-results, allure-report</p>
